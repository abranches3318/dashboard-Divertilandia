<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Agendamentos - Divertilândia</title>

  <!-- CSS -->
  <link rel="stylesheet" href="../css/dashboard.css" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script src="../firebase-config.js"></script>
  <script src="../protect.js"></script>

  <style>
    .ag-lista { margin-top: 20px; }
    .ag-item { background: #1b1b1b; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
    .ag-item div { display: flex; flex-direction: column; }
    .btn { padding: 6px 12px; margin-left: 5px; }
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
    .modal.active { display: flex; }
    .modal-content { background: #1a1a1a; padding: 25px; border-radius: 12px; width: 450px; }
  </style>
</head>
<body>

  <header class="topbar">
    <h1 id="titulo-pagina">Agendamentos</h1>
    <div>
      <button class="btn" onclick="window.history.back()">⬅ Voltar</button>
    </div>
  </header>

  <main class="content" style="padding:20px;">
    <h2 id="data-agendamento"></h2>
    <button class="btn" onclick="abrirModalNovo()">➕ Novo Agendamento</button>

    <div id="lista-agendamentos" class="ag-lista"></div>
  </main>

  <!-- Modal Novo/Edit -->
  <div id="modal-agendamento" class="modal">
    <div class="modal-content">
      <h3 id="modal-titulo">Novo Agendamento</h3>
      <input type="hidden" id="ag-id">
      <label>Cliente</label>
      <input type="text" id="ag-cliente" placeholder="Nome do cliente">
      <label>Item / Serviço</label>
      <input type="text" id="ag-item" placeholder="Item ou serviço">
      <label>Valor</label>
      <input type="number" id="ag-valor" placeholder="Valor">
      <label>Horário</label>
      <input type="time" id="ag-horario">
      <div style="margin-top:15px; display:flex; justify-content:flex-end;">
        <button class="btn btn-dark" onclick="fecharModal()">Cancelar</button>
        <button class="btn btn" onclick="salvarAgendamento()">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    const db = firebase.firestore();
    const urlParams = new URLSearchParams(window.location.search);
    const dataParam = urlParams.get('data'); // YYYY-MM-DD
    const listaEl = document.getElementById('lista-agendamentos');
    const dataTitulo = document.getElementById('data-agendamento');
    const modal = document.getElementById('modal-agendamento');

    let agendamentosDia = [];

    if (!dataParam) {
      alert("Data inválida!");
      window.history.back();
    } else {
      dataTitulo.textContent = `Agendamentos de ${dataParam.split('-').reverse().join('/')}`;
      carregarAgendamentos();
    }

    function carregarAgendamentos() {
      db.collection("agendamentos")
        .where("data_evento", "==", dataParam)
        .orderBy("horario", "asc")
        .onSnapshot(snap => {
          agendamentosDia = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderizarAgendamentos();
        });
    }

    function renderizarAgendamentos() {
      if (agendamentosDia.length === 0) {
        listaEl.innerHTML = "<p>Nenhum agendamento neste dia.</p>";
        return;
      }

      listaEl.innerHTML = agendamentosDia.map(a => `
        <div class="ag-item">
          <div>
            <strong>${a.cliente || '-'}</strong>
            <span>${a.item_nome || '-'}</span>
            <span>Valor: R$ ${Number(a.valor_entrada||0).toFixed(2)}</span>
            <span>Horário: ${a.horario||'-'}</span>
          </div>
          <div>
            <button class="btn btn-dark" onclick="abrirModalEdit('${a.id}')">Editar</button>
            <button class="btn btn-danger" onclick="excluirAgendamento('${a.id}')">Cancelar</button>
          </div>
        </div>
      `).join('');
    }

    function abrirModalNovo() {
      document.getElementById('modal-titulo').textContent = 'Novo Agendamento';
      document.getElementById('ag-id').value = '';
      document.getElementById('ag-cliente').value = '';
      document.getElementById('ag-item').value = '';
      document.getElementById('ag-valor').value = '';
      document.getElementById('ag-horario').value = '';
      modal.classList.add('active');
    }

    function abrirModalEdit(id) {
      const ag = agendamentosDia.find(a => a.id === id);
      if (!ag) return;
      document.getElementById('modal-titulo').textContent = 'Editar Agendamento';
      document.getElementById('ag-id').value = ag.id;
      document.getElementById('ag-cliente').value = ag.cliente || '';
      document.getElementById('ag-item').value = ag.item_nome || '';
      document.getElementById('ag-valor').value = ag.valor_entrada || '';
      document.getElementById('ag-horario').value = ag.horario || '';
      modal.classList.add('active');
    }

    function fecharModal() {
      modal.classList.remove('active');
    }

    async function salvarAgendamento() {
      const id = document.getElementById('ag-id').value;
      const cliente = document.getElementById('ag-cliente').value.trim();
      const item_nome = document.getElementById('ag-item').value.trim();
      const valor_entrada = Number(document.getElementById('ag-valor').value || 0);
      const horario = document.getElementById('ag-horario').value;

      if (!cliente || !item_nome || !horario) {
        alert("Preencha todos os campos obrigatórios!");
        return;
      }

      const dados = {
        cliente_nome: cliente,
        item_nome,
        valor_entrada,
        horario,
        data_evento: dataParam,
        criado_em: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (id) {
        // edição
        await db.collection("agendamentos").doc(id).set(dados, { merge: true });
      } else {
        // novo
        await db.collection("agendamentos").add(dados);
      }

      fecharModal();
    }

    async function excluirAgendamento(id) {
      if (!confirm("Deseja realmente cancelar este agendamento?")) return;
      await db.collection("agendamentos").doc(id).delete();
    }
  </script>

</body>
</html>
